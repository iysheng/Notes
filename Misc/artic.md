### 基于 Linux 的智能灯具控制器软件设计


##### 摘 要：
    针对如港口、厂房等对灯光照明有要求的场所，如何在保证经济效益的前提下，节能减排成为了一个可以切入的点，针对此，设计了基于嵌入式 Linux 的智能灯具控制器。尝试通过智能控制的技术，保证灯具效果的情况下，动态调整灯具的亮度等级，达到节能的目的。
#### 0 引 言
	目前，国内港口码头的作业均采用全天侯工作模式，规模庞大的高杆灯群是保证港口码头夜间作业的必要设施。

#### 1 总体设计


#### 2 软件设计
    智能灯具控制器的软件设计基于嵌入式 Linux 操作系统开发。嵌入式 Linux 操作系统是一类用于嵌入式设备的 Linux 操作系统。是裁剪过的、具有专用性的 Linux。而 Linux 则是一款类 UNIX 的开源操作系统，最初是 Linus Torvalds 在 1991 年开发。到目前为止， 根据公开的资料可知，在 2015 年基于 Linux 操作系统的嵌入式设备的市场份额就已经超过了 50%，这得益 Linux 的 free 特点，导致 Linux 特别流行，资料和工具都很丰富，所以容易上手。除了系统的源码之外，还可以很方便的编译对应的交叉变异工具链，容易获取的开发环境也是社区或者厂商愿意选择 Linux 作为系统开发的操作系统的原因。基于 Linux 的如上特点，采取基于嵌入式 Linux 操作系统完成本次智能灯具控制器的软件设计。
    智能灯具控制器的目的是减少人为对作业环境灯光控制的干预，实现自动化、智能化的灯光环境控制，在保证满足作业灯光环境要求的前提下，尽量降低能耗，响应国家号召实现节能减排以及智能制造。

    智能灯具控制器软件基于 Linux，采用多线程编程的设计方法，多线程软件相比单进程以及单线程具有更高的执行效率，通过将大量的任务分配给不同的线程，这样当一个任务阻塞的时候，可以继续执行其他任务，避免了导致 CPU 的浪费，特别是在多 CPU 的系统环境，可以更大化的提高 CPU 的利用率。同时，多线程和多进程相比，具有更加高效率的资源共享策略，因为同属一个进程的多线程具有相同的内存空间，而多进程之间具有各自独立的内存空间，这样在资源共享方面，多线程更加高效率。创建线程和线程切换的开销相比创建进程和进程切换更低，同时线程的启动速度相比进程的启动速度至少快 4 倍。

    线程是操作系统处理任务的最小单元，为了最大化的体现多线程的高效率，将整体的智能灯具控制器的功能拆分为多个模块，分派给多个线程处理。灯具控制器的整体框图为：


    从图-1 可知，整个灯具控制器的软件可以分三层，分别是：内核、库函数和应用程序，应用程序直接或者间接地通过系统调用到内核态，完成和灯具控制器的硬件通讯。重点的开发工作是在应用程序这个层次。应用程序的软件框架可以展示为：

	从图-2 可知，整个灯具控制器软件的应用为单进程多线程架构。以港口岸桥这种场合为例，工作状态下，系统一共包含 10 个线程：具体线程负责的任务如表-1：
|线程名|任务描述|
|---|---|
|JLedSrv|系统的 main 线程|
|watchdog|看门狗线程，负责监控系统工作是否异常，异常时重启系统|
|screen|监控串口触摸屏幕消息并派发消息以及负责屏幕显示内容的线程|
|loraspi|接收 lora 模块收到的消息的线程|
|modbus|通过 modbus 模块解析岸桥小车的位置信息，根据小车的位置信息完成自动亮度调节|
|power|扫描末端灯具状态并统计末端灯具的能耗|
|plan|处理本地预案的线程|
|network|接受并提取网络数据包消息的线程|
|handle_screen|处理触摸屏幕消息的线程|
|handle_network|处理平台的网络数据包消息的线程|
	当系统启动时，会首先到 JLedSrv 这个 main 线程，在该线程通过解析配置文件关于线程集合的定义，创建对应的线程，特别地，考虑到触摸屏命令解析、平台网络数据包解析以及和灯具的通讯这三大模块具有明显的异步性和并发的可能，为了提高系统的执行效率，采用了类 C-S 架构的处理方法。在处理触摸屏命令的时候，Client 端可以认为是线程 screen。这个线程单纯的倾听通过串口和 arm 核心控制链接的句柄，当有触摸事件发生时，该线程就可以及时获取到对应的数据，如果对数据教研通过，就会提取有用的信息，然后直接派发给处理该命令的线程 handle_screen，handle_screen 线程就类似于后台的服务端处理触摸屏事件，这样就可以实现在处理触摸屏事件的时候，不至于完全卡住无法处理下一个事件。关于平台网络的命令解析也是类似的，有作为类 Client 的 network 线程和类 Server 的 handle_network 线程。关于通过 Lora 模块和末端灯具通讯的任务，考虑的多个线程都有可能触发和灯具控制事件：比如到达了预案定义的时间节点、平台有控灯动作或者本地有控灯动作，再加上和末端灯具的通讯，除了广播情况，单播都是要保证一发一收的可靠通讯，如果将发送和接收数据放在同一个线程，那么处理并发问题的时候，就不可避免的需要加锁来保证互斥。但是考虑到对 Lora 数据的接收具有明显的延迟性，所以如过锁加的时间太长，在以上列举的三个场合就有可能出现明显卡顿的现象，举例来说，如果当预案线程因为预设的时间到达，执行单灯控制指令，同时，平台端也触发的控灯的动作，这时候因为单灯控制会在读取 Lora 模块数据返回后才会释放对应的锁，所以平台端会一直卡在控灯的界面，这时候就会出现卡端的现象，这是优秀的产品不应该具有的效果。
	通过上述分析，为了保证系统可以快速响应以及数据处理的一致性，设计通过 Lora 和末端灯具的通讯方案时，采用了将数据接收的任务全部放在了线程 loraspi 完成，该线程完全负责接收 Lora 模块的数据，然后将数据保存到缓存区域。其他线程在获取 Lora 模块接收到数据的时候可以直接从缓冲区取数据。同时，在等待 Lora 模块返回数据时，添加了超时时间，loraspi 线程通过信号量的方式通知等待消息的线程。通过这两个措施，可以保证系统不会出现长时间卡住的现象。
#### 3 结束语
	本文根据智能灯具控制器软件的系统要求，设计开发了基于 Linux 操作系统的灯具控制器应用服务程序。针对系统具有模块数量多，关联较为复杂的特点，采用了单进程多线程的框架设计。系统参数配置通过 cJSON 格式的文本文件确定，实现了配置和功能分离的功能，可以保证程序具有更好的适应性以及避免了修改配置需要重新变异文件的步骤，可以明显降低后续维护的负责性。该系统的实现方法和框架设计，具有明显的灵活性、和快速响应的特点，具有一定的实际意义和运用推广价值。
#### 参考文献：

